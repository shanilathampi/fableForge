<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FableForge - AI Interactive Fiction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap');
        
        body {
            font-family: 'Merriweather', serif;
            background-color: #0f172a;
        }
        
        .font-display { font-family: 'Cinzel', serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .fade-in { animation: fadeIn 0.8s ease-out forwards; opacity: 0; }
        .slide-up { animation: slideUp 0.5s ease-out forwards; opacity: 0; transform: translateY(20px); }
        
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        .prose-custom p { margin-bottom: 1rem; line-height: 1.8; color: #e2e8f0; }
        
        /* Loading Pulse */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 h-screen flex flex-col overflow-hidden selection:bg-amber-900/50">

    <!-- Header -->
    <header class="h-16 border-b border-slate-800 bg-slate-900/80 backdrop-blur-md flex items-center justify-between px-6 z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-red-700 rounded-full flex items-center justify-center shadow-lg shadow-amber-900/20">
                <i data-lucide="scroll" class="w-4 h-4 text-white"></i>
            </div>
            <h1 class="text-xl font-display font-bold text-amber-50 tracking-wider">FableForge</h1>
        </div>
        <button onclick="toggleSettings()" class="text-slate-400 hover:text-amber-400 transition-colors">
            <i data-lucide="settings" class="w-5 h-5"></i>
        </button>
    </header>

    <!-- SETUP SCREEN -->
    <div id="screen-setup" class="flex-1 flex flex-col items-center justify-center p-6 relative overflow-hidden z-10">
        <!-- Background Decor -->
        <div class="absolute inset-0 z-0 opacity-20 pointer-events-none">
            <div class="absolute top-0 left-0 w-64 h-64 bg-amber-600 rounded-full blur-[100px]"></div>
            <div class="absolute bottom-0 right-0 w-96 h-96 bg-purple-900 rounded-full blur-[120px]"></div>
        </div>

        <div class="w-full max-w-md space-y-8 relative z-10 slide-up">
            <div class="text-center space-y-2">
                <h2 class="text-3xl font-display font-bold text-white">Begin Your Saga</h2>
                <p class="text-slate-400 sans-serif">Choose your path and let the AI weave your destiny.</p>
            </div>

            <div class="bg-slate-900/50 border border-slate-800 p-6 rounded-xl space-y-5 backdrop-blur-sm">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 font-sans">Protagonist Name</label>
                    <input type="text" id="setup-name" placeholder="e.g. Elara, Kael, Dr. Smith" 
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-amber-50 focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition-all font-sans">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 font-sans">Genre</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectGenre(this, 'Fantasy')" class="genre-btn active ring-1 ring-amber-500 bg-amber-900/20 text-amber-200 px-4 py-3 rounded-lg border border-transparent hover:bg-slate-800 transition-all font-sans text-sm font-medium">
                            <i data-lucide="sword" class="w-4 h-4 mb-1 mx-auto"></i> Fantasy
                        </button>
                        <button onclick="selectGenre(this, 'Sci-Fi')" class="genre-btn bg-slate-950 text-slate-400 px-4 py-3 rounded-lg border border-slate-800 hover:bg-slate-800 transition-all font-sans text-sm font-medium">
                            <i data-lucide="rocket" class="w-4 h-4 mb-1 mx-auto"></i> Sci-Fi
                        </button>
                        <button onclick="selectGenre(this, 'Mystery')" class="genre-btn bg-slate-950 text-slate-400 px-4 py-3 rounded-lg border border-slate-800 hover:bg-slate-800 transition-all font-sans text-sm font-medium">
                            <i data-lucide="search" class="w-4 h-4 mb-1 mx-auto"></i> Mystery
                        </button>
                        <button onclick="selectGenre(this, 'Horror')" class="genre-btn bg-slate-950 text-slate-400 px-4 py-3 rounded-lg border border-slate-800 hover:bg-slate-800 transition-all font-sans text-sm font-medium">
                            <i data-lucide="ghost" class="w-4 h-4 mb-1 mx-auto"></i> Horror
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-2">
                    <label class="flex items-center gap-2 text-sm text-slate-400 font-sans cursor-pointer">
                        <input type="checkbox" id="setup-images" checked class="w-4 h-4 rounded border-slate-700 bg-slate-950 text-amber-600 focus:ring-amber-500 focus:ring-offset-slate-900">
                        Generate Scenes (Imagen)
                    </label>
                </div>
            </div>

            <button onclick="startGame()" class="w-full bg-gradient-to-r from-amber-700 to-amber-600 hover:from-amber-600 hover:to-amber-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-amber-900/30 transform hover:scale-[1.02] transition-all flex items-center justify-center gap-2 font-display tracking-widest uppercase">
                <span>Start Adventure</span> <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
            
            <p id="setup-error" class="text-red-400 text-sm text-center font-sans hidden"></p>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="hidden flex-1 flex flex-col md:flex-row h-[calc(100vh-64px)] overflow-hidden">
        
        <!-- Left: Story & Controls -->
        <div class="flex-1 flex flex-col h-full relative order-2 md:order-1">
            
            <!-- Story Log -->
            <div id="story-log" class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth">
                <div class="max-w-2xl mx-auto space-y-8 pb-32">
                    <!-- Dynamic content will be injected here -->
                </div>
            </div>

            <!-- Choice Area (Fixed Bottom) -->
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-slate-950 via-slate-950 to-transparent pt-12 pb-8 px-6 z-10">
                <div class="max-w-2xl mx-auto space-y-3" id="choice-container">
                    <!-- Buttons injected here -->
                </div>
            </div>
        </div>

        <!-- Right: Visuals & Stats (Sidebar) -->
        <div class="w-full md:w-96 bg-slate-900 border-l border-slate-800 flex flex-col shrink-0 order-1 md:order-2 h-[200px] md:h-auto border-b md:border-b-0 relative group">
            
            <!-- Scene Image -->
            <div class="relative w-full h-full md:h-64 bg-black shrink-0 overflow-hidden">
                <img id="scene-image" class="w-full h-full object-cover opacity-80 transition-opacity duration-1000" src="" alt="Scene">
                <div class="absolute inset-0 bg-gradient-to-b from-transparent to-slate-900/90"></div>
                
                <!-- Loading Overlay -->
                <div id="img-loading" class="absolute inset-0 flex items-center justify-center bg-slate-950/50 backdrop-blur-sm hidden">
                    <i data-lucide="loader-2" class="w-8 h-8 text-amber-500 animate-spin"></i>
                </div>
            </div>

            <!-- Stats Panel (Desktop: Below image, Mobile: Absolute Overlay toggleable) -->
            <div class="flex-1 p-6 space-y-6 overflow-y-auto hidden md:block bg-slate-900">
                
                <!-- HP Widget -->
                <div>
                    <div class="flex justify-between text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 font-sans">
                        <span>Health</span>
                        <span id="hp-text" class="text-amber-500">100/100</span>
                    </div>
                    <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
                        <div id="hp-bar" class="h-full bg-gradient-to-r from-red-600 to-amber-600 w-full transition-all duration-500"></div>
                    </div>
                </div>

                <!-- Inventory -->
                <div>
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 font-sans flex items-center gap-2">
                        <i data-lucide="backpack" class="w-4 h-4"></i> Inventory
                    </h3>
                    <div id="inventory-list" class="grid gap-2">
                        <div class="text-sm text-slate-600 italic font-sans px-3 py-2 border border-slate-800 rounded-lg">Empty</div>
                    </div>
                </div>

                <!-- Game Status -->
                <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-800/50">
                    <h4 class="text-amber-500 font-display font-bold text-sm mb-1" id="status-name">Player</h4>
                    <p class="text-xs text-slate-400 font-sans" id="status-genre">Adventurer</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settings-overlay" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
        <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h2 class="text-xl font-display font-bold text-white mb-6">Settings</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-sans font-medium text-slate-400 mb-2">Google Gemini API Key</label>
                    <input type="password" id="api-key-input" placeholder="Paste your API key here..." 
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-amber-500 font-sans">
                    <p class="text-xs text-slate-500 mt-2 font-sans">
                        Required for gameplay. Stored locally.
                    </p>
                </div>
                <button onclick="saveSettings()" class="w-full bg-amber-700 hover:bg-amber-600 text-white font-sans font-bold py-3 rounded-lg transition-colors">
                    Save Configuration
                </button>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-red-900/90 text-white px-6 py-3 rounded-full shadow-xl transform -translate-y-20 transition-transform duration-300 z-50 font-sans flex items-center gap-3">
        <i data-lucide="alert-circle" class="w-5 h-5"></i>
        <span id="toast-msg">Error message</span>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const defaultApiKey = ""; // Environment injected
        let apiKey = defaultApiKey;
        
        let gameState = {
            name: "",
            genre: "Fantasy",
            hp: 100,
            inventory: [],
            history: [], // Array of text turns
            turnCount: 0,
            imageEnabled: true
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const savedKey = localStorage.getItem('fableforge_api_key');
            if (savedKey) apiKey = savedKey;
            if (apiKey) document.getElementById('api-key-input').value = apiKey;
        });

        // --- UI FUNCTIONS ---
        function toggleSettings() {
            const el = document.getElementById('settings-overlay');
            el.classList.toggle('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('fableforge_api_key', key);
                toggleSettings();
                showToast("API Key Saved", false);
            }
        }

        function selectGenre(btn, genre) {
            document.querySelectorAll('.genre-btn').forEach(b => {
                b.classList.remove('active', 'ring-1', 'ring-amber-500', 'bg-amber-900/20', 'text-amber-200');
                b.classList.add('bg-slate-950', 'text-slate-400', 'border-slate-800');
            });
            btn.classList.remove('bg-slate-950', 'text-slate-400', 'border-slate-800');
            btn.classList.add('active', 'ring-1', 'ring-amber-500', 'bg-amber-900/20', 'text-amber-200');
            gameState.genre = genre;
        }

        function showToast(msg, isError = true) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toast.className = `fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-xl transform transition-transform duration-300 z-50 font-sans flex items-center gap-3 ${isError ? 'bg-red-900/90 text-white' : 'bg-emerald-800/90 text-white'}`;
            toastMsg.innerText = msg;
            toast.style.transform = 'translate(-50%, 0)';
            setTimeout(() => {
                toast.style.transform = 'translate(-50%, -150%)';
            }, 3000);
        }

        // --- GAME LOGIC ---

        async function startGame() {
            const nameInput = document.getElementById('setup-name').value.trim();
            if (!apiKey) {
                toggleSettings();
                showToast("Please enter an API Key first.");
                return;
            }
            if (!nameInput) {
                const err = document.getElementById('setup-error');
                err.innerText = "Please name your hero.";
                err.classList.remove('hidden');
                return;
            }

            gameState.name = nameInput;
            gameState.imageEnabled = document.getElementById('setup-images').checked;
            
            // UI Transition
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            
            // Update Sidebar
            document.getElementById('status-name').innerText = gameState.name;
            document.getElementById('status-genre').innerText = `The ${gameState.genre} Saga`;

            // Start Generative Loop
            addLoader();
            try {
                const prompt = `Start a new ${gameState.genre} text adventure for a protagonist named ${gameState.name}. 
                Set the scene, describe the starting situation, and offer choices.`;
                
                await turn(prompt, true);
            } catch (e) {
                showToast(e.message);
                removeLoader();
            }
        }

        async function handleChoice(choiceText) {
            // Disable buttons
            const buttons = document.querySelectorAll('#choice-container button');
            buttons.forEach(b => {
                b.disabled = true;
                b.classList.add('opacity-50', 'cursor-not-allowed');
            });

            // Add user choice to log visually
            const log = document.getElementById('story-log').firstElementChild;
            const choiceDiv = document.createElement('div');
            choiceDiv.className = "text-right fade-in my-4";
            choiceDiv.innerHTML = `<span class="inline-block bg-slate-800 text-slate-300 rounded-lg px-4 py-2 font-sans text-sm border border-slate-700 italic">"${choiceText}"</span>`;
            log.appendChild(choiceDiv);
            
            // Scroll
            const scrollContainer = document.getElementById('story-log');
            scrollContainer.scrollTop = scrollContainer.scrollHeight;

            addLoader();
            
            try {
                await turn(choiceText, false);
            } catch (e) {
                showToast("Connection failed. Retrying...");
                console.error(e);
                removeLoader();
                // Re-enable buttons if fail? Or just show error.
            }
        }

        async function turn(userInput, isStart) {
            // 1. Construct History Context (Last 5 turns to save tokens, but keep start)
            // Simplified: We send a compact summary of state + last few exchanges + new input.
            
            const systemPrompt = `
            You are FableForge, an interactive fiction engine. 
            Role: Dungeon Master.
            Genre: ${gameState.genre}.
            Player: ${gameState.name}.
            Current HP: ${gameState.hp}.
            Inventory: ${JSON.stringify(gameState.inventory)}.

            Rules:
            1. Output strictly valid JSON.
            2. Narrative should be immersive, descriptive (approx 60-100 words).
            3. Provide 2-4 distinct choices for the player.
            4. Update HP and Inventory based on events (e.g., combat, finding items).
            5. 'image_prompt' should be a vivid visual description of the CURRENT scene for an AI image generator (no text in image).

            JSON Schema:
            {
                "narrative": "string (html allowed for bold/italics)",
                "choices": ["string", "string"],
                "image_prompt": "string",
                "hp_change": integer (e.g. -10, 0, +5),
                "inventory_add": "string or null",
                "inventory_remove": "string or null"
            }
            `;

            let userPrompt = "";
            if (isStart) {
                userPrompt = userInput;
            } else {
                userPrompt = `Player chose: "${userInput}". Continue the story.`;
            }

            // 2. Call Gemini
            const data = await fetchGemini(systemPrompt, userPrompt);
            
            // 3. Update State
            gameState.hp = Math.min(100, Math.max(0, gameState.hp + (data.hp_change || 0)));
            if (data.inventory_add) gameState.inventory.push(data.inventory_add);
            if (data.inventory_remove) {
                gameState.inventory = gameState.inventory.filter(i => i !== data.inventory_remove);
            }
            gameState.history.push({ role: 'user', text: userPrompt });
            gameState.history.push({ role: 'model', text: data.narrative });

            // 4. Render
            removeLoader();
            renderStory(data.narrative);
            renderChoices(data.choices);
            updateStats();

            // 5. Image Gen (Async, doesn't block text)
            if (gameState.imageEnabled && data.image_prompt) {
                generateSceneImage(data.image_prompt);
            }
        }

        // --- RENDERING ---

        function addLoader() {
            const log = document.getElementById('story-log').firstElementChild;
            const loader = document.createElement('div');
            loader.id = 'turn-loader';
            loader.className = "flex items-center gap-1 py-4 fade-in";
            loader.innerHTML = `
                <div class="w-2 h-2 bg-amber-600 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-amber-600 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-amber-600 rounded-full typing-dot"></div>
            `;
            log.appendChild(loader);
            const scrollContainer = document.getElementById('story-log');
            scrollContainer.scrollTop = scrollContainer.scrollHeight;
        }

        function removeLoader() {
            const loader = document.getElementById('turn-loader');
            if (loader) loader.remove();
        }

        function renderStory(text) {
            const log = document.getElementById('story-log').firstElementChild;
            const p = document.createElement('div');
            p.className = "prose-custom text-lg md:text-xl font-serif text-slate-200 fade-in border-l-2 border-slate-800 pl-4";
            p.innerHTML = text; // Gemini returns clean text usually, strictly safer to parse if needed but trust for demo
            log.appendChild(p);
            
            // Auto scroll
            const scrollContainer = document.getElementById('story-log');
            setTimeout(() => {
                scrollContainer.scrollTo({ top: scrollContainer.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function renderChoices(choices) {
            const container = document.getElementById('choice-container');
            container.innerHTML = ''; // Clear old
            
            choices.forEach((choice, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left bg-slate-900 hover:bg-slate-800 border border-slate-800 hover:border-amber-700/50 text-slate-300 hover:text-amber-100 p-4 rounded-lg transition-all duration-200 group slide-up font-sans text-sm md:text-base";
                btn.style.animationDelay = `${idx * 100}ms`;
                btn.onclick = () => handleChoice(choice);
                
                btn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="bg-slate-800 text-slate-500 group-hover:bg-amber-900 group-hover:text-amber-500 w-6 h-6 rounded flex items-center justify-center text-xs font-bold transition-colors">${idx + 1}</span>
                        <span>${choice}</span>
                    </div>
                `;
                container.appendChild(btn);
            });
        }

        function updateStats() {
            // HP
            const hpBar = document.getElementById('hp-bar');
            const hpText = document.getElementById('hp-text');
            hpBar.style.width = `${gameState.hp}%`;
            hpText.innerText = `${gameState.hp}/100`;
            
            // Color shift based on HP
            if (gameState.hp < 30) hpBar.className = "h-full bg-red-600 w-full transition-all duration-500";
            else hpBar.className = "h-full bg-gradient-to-r from-red-600 to-amber-600 w-full transition-all duration-500";

            // Inventory
            const invList = document.getElementById('inventory-list');
            if (gameState.inventory.length === 0) {
                invList.innerHTML = `<div class="text-sm text-slate-600 italic font-sans px-3 py-2 border border-slate-800 rounded-lg">Empty</div>`;
            } else {
                invList.innerHTML = gameState.inventory.map(item => `
                    <div class="text-sm text-slate-300 font-sans px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg flex items-center gap-2">
                        <div class="w-1.5 h-1.5 bg-amber-500 rounded-full"></div> ${item}
                    </div>
                `).join('');
            }
        }

        // --- API CALLS ---

        async function fetchGemini(systemPrompt, userPrompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // Construct message history for context (last 6 items + system)
            // Note: System instruction is supported in the API object
            
            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [
                    // Provide context from history (limited to last few turns to manage context window strictly)
                    ...gameState.history.slice(-6), 
                    { role: "user", parts: [{ text: userPrompt }] }
                ],
                generationConfig: {
                    responseMimeType: "application/json"
                }
            };

            const response = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("No story generated");
            return JSON.parse(text);
        }

        async function generateSceneImage(prompt) {
            const loading = document.getElementById('img-loading');
            loading.classList.remove('hidden');
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
                // Enhancing prompt for better style consistency
                const enhancedPrompt = `${prompt}. Cinematic lighting, detailed, ${gameState.genre} art style, digital painting, 8k resolution, atmospheric.`;
                
                const response = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instances: [{ prompt: enhancedPrompt }],
                        parameters: { sampleCount: 1 }
                    })
                });

                const data = await response.json();
                const b64 = data.predictions?.[0]?.bytesBase64Encoded;
                
                if (b64) {
                    const img = document.getElementById('scene-image');
                    img.style.opacity = 0; // Fade out
                    setTimeout(() => {
                        img.src = `data:image/png;base64,${b64}`;
                        img.onload = () => { img.style.opacity = 0.8; }; // Fade in
                    }, 500);
                }
            } catch (e) {
                console.error("Image gen failed", e);
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (!res.ok) {
                        if (res.status === 429) throw new Error("Too many requests");
                        const err = await res.json();
                        throw new Error(err.error?.message || res.statusText);
                    }
                    return res;
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
                }
            }
        }
    </script>
</body>
</html>
